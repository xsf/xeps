<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE xep SYSTEM 'xep.dtd' [
  <!ENTITY % ents SYSTEM 'xep.ent'>
%ents;
]>
<?xml-stylesheet type='text/xsl' href='xep.xsl'?>
<?xml-stylesheet type="text/css" href="xmpp.css"?>
<xep>
<header>
  <title>References</title>
  <abstract>This document defines a method for one XMPP stanza to provide references to another entity, such as mentioning users, HTTP resources, or other XMPP resources.</abstract>
  &LEGALNOTICE;
  <number>0372</number>
  <status>Experimental</status>
  <type>Standards Track</type>
  <sig>Standards</sig>
  <approver>Council</approver>
  <dependencies>
    <spec>XMPP Core</spec>
    <spec>XMPP IM</spec>
    <spec>XEP-0030</spec>
    <spec>XEP-0115</spec>
  </dependencies>
  <supersedes/>
  <supersededby/>
  <shortname>Refs</shortname>
  &ksmithisode;
  <revision>
    <version>0.6.0</version>
    <date>2023-04-03</date>
    <initials>tj</initials>
    <remark>
      <ul>
        <li>Redefine types</li>
        <li>Make uri parameter non mandatory</li>
        <li>Remove the mentions chapter (defined in another XEP)</li>
        <li>Add reference to &xep0426;</li>
        <li>Add hreflang attribute</li>
        <li>Bump the namespace</li>
      </ul>
    </remark>
  </revision>
  <revision>
    <version>0.5.0</version>
    <date>2020-12-09</date>
    <initials>kis</initials>
    <remark>Specify counting should be of code points.</remark>
  </revision>
  <revision>
    <version>0.4.0</version>
    <date>2020-12-08</date>
    <initials>gh/jcbrand</initials>
    <remark>Specify that begin is inclusive, starts counting at zero, and that end is exclusive (Dijkstra-based convention).</remark>
  </revision>
  <revision>
    <version>0.3</version>
    <date>2019-09-04</date>
    <initials>(mb)</initials>
    <remark>Make Pubsub URIs in sections 3.3 and 3.4 conform to XEP-0147.</remark>
  </revision>
  <revision>
    <version>0.2</version>
    <date>2017-09-11</date>
    <initials>XEP Editor (jwi)</initials>
    <remark>Defer due to lack of activity.</remark>
  </revision>
  <revision>
    <version>0.1</version>
    <date>2016-03-22</date>
    <initials>XEP Editor (asw)</initials>
    <remark><p>Initial published version approved by the XMPP Council.</p></remark>
  </revision>
  <revision>
    <version>0.0.1</version>
    <date>2016-01-29</date>
    <initials>kis</initials>
    <remark><p>First draft.</p></remark>
  </revision>
</header>
<section1 topic='Introduction' anchor='intro'>
  <p>
    It's often desirable to encode a reference to another entity within a chat message and to mark up the reference. Examples of this include HTTP URLs, 'mentions' (referring to another user), references to previous messages and references to &xep0346; (FDP) forms. This document provides a mechanism for marking up a section of a message body with information about the target of the reference.
  </p>
</section1>

<!--<section1 topic='Requirements' anchor='reqs'>
  <ul>
    <li></li>
 </ul>
</section1>-->



<section1 topic='Discovery' anchor='discovery'>
  <p>If an entity implements references, it MUST specify the 'urn:xmpp:reference:1' feature in its service discovery information features as specified in &xep0030; and the Entity Capabilities profile specified in &xep0115;.</p>

  <p>If the entity is also implementing specific references profiles, it MUST expose the specific feature defined in the related type.</p>

  <example caption='Contact&apos;s client responds with specific features profiles'><![CDATA[
<iq type='result'
    id='disco1'
    from='juliet@capulet.lit/sabo239'
    to='romeo@montegue.lit/30d3d8'>
  <query xmlns='http://jabber.org/protocol/disco#info'>
    ...
    <feature var='urn:xmpp:reference:1'/>
    <feature var='urn:xmpp:reference:data:1'/>
    ...
  </query>
</iq>
  ]]></example>
</section1>

<section1 topic='Use Cases' anchor='usecases'>
  <section2 topic='Generics' anchor='usecase_generics'>
    <p>References are provided in a 'reference' element of a message, with a namespace of 'urn:xmpp:reference:1'. The element MUST contain a 'type' attribute denoting the type of the reference. Other profile specific attributes MAY be specified. It also MAY contain 'begin', 'end', 'hreflang' and 'anchor' elements.</p>

    <section3 topic="Begin and end attributes" anchor="begin_end">
      <p>The character counting is done as specified in &xep0426;. Implementations SHOULD NOT send multiple references with overlapping ranges.</p>
    </section3>

    <section3 topic="Anchor attribute" anchor="anchor">
      <p>An 'anchor' attribute is used when the referring message is not the one containing the reference element, and points to the previous message containing the reference (the referring message). Its value is an URI pointing to the reffering message.</p>
      <p>Note that the URIs of the reference and anchor do not need to refer to the same mechanism as that in which the reference was received. E.g., a service could listen for mentions in a MIX channels of users outside that channel, and send them messages containing a reference to let them know that they've been mentioned.</p>
    </section3>

    <section3 topic="Hreflang attribute" anchor="href_lang">
      <p>An implementation MAY use the 'hreflang' attribute to target a message with the corresponding 'xml:lang' attribute, when 'begin' and 'end' attributes are specified.</p>
    </section3>
  </section2>
  <section2 topic='Data' anchor='usecase_data'>
    <p>Data references are a generic reference without additional information. The reference element MUST contain a 'uri' attribute that points to an 'item' that is able to be fetched. This is useful for, for example, fetching an item from Pubsub as defined in <span class='ref'><link url='https://xmpp.org/extensions/xep-0060.html#impl-uri'>Publish-Subscribe (XEP-0060) - Pubsub URIs</link></span>.</p>
    <example caption='A MIX Channel sends a message that a new FDP form has been submitted elsewhere'><![CDATA[
<message type='groupchat'
         id='sotehu-bthbtp32h4'
         from='balcony@channels.shakespeare.lit'
         to='romeo@montegue.lit/30d3d8'>
  <body>Form received</body>
  <reference xmlns='urn:xmpp:reference:1'
             type='urn:xmpp:reference:data:1'
             uri='xmpp:fdp.shakespeare.lit?;node=fdp/submitted/stan.net/accidentreport;item=ndina872be'/>
</message>
]]></example>
  </section2>
  <section2 topic='Previous messages' anchor='usecase_previous'>
    <p>Sometimes it's desirable to annotate a reference in a previous message. An example of this might be where a MIX channel asynchronously adds information about references made in previous messages by users. In this case the message MUST NOT contain a body. Here the anchor attribute is used to provide a URI to the previous message.</p>
    <example caption='A MIX Channel annotates a previous user message'><![CDATA[
<message type='groupchat'
         id='sotehu-bthbtp32h5'
         from='balcony@channels.shakespeare.lit'
         to='romeo@montegue.lit/30d3d8'>
  <reference xmlns='urn:xmpp:reference:0'
             type='data'
             anchor='xmpp:balcony@channels.shakespeare.lit?;node=messages;item=bnhob'
             begin='72'
             end='78'
             uri='xmpp:fdp.shakespeare.lit?;node=fdp/submitted/stan.net/accidentreport;item=ndina872be'/>
</message>
]]></example>
  </section2>

</section1>


<!--<section1 topic='Business Rules' anchor='rules'>
  <ul>
    <li>.</li>
  </ul>
</section1>-->
<!--<section1 topic='Implementation Notes' anchor='impl'>
  <p>OPTIONAL.</p>
</section1>
<section1 topic='Accessibility Considerations' anchor='access'>
  <p>OPTIONAL.</p>
</section1>
<section1 topic='Internationalization Considerations' anchor='i18n'>
  <p>OPTIONAL.</p>
</section1>-->
<section1 topic='Security Considerations' anchor='security'>
  <p>TODO.</p>
</section1>
<section1 topic='IANA Considerations' anchor='iana'>
  <p>None.</p>
</section1>
<section1 topic='XMPP Registrar Considerations' anchor='registrar'>
  <p>Needs a namespace.</p>
</section1>
<section1 topic='XML Schema' anchor='schema'>
  <section2 topic='Reference base schema' anchor='schemas-reference'>
    <p>The following schema defines the base reference element.</p>
    <code><![CDATA[
<?xml version='1.0' encoding='UTF-8'?>

<xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    xmlns:xhtml='http://www.w3.org/1999/xhtml'
    targetNamespace='urn:xmpp:reference:1'
    xmlns='urn:xmpp:reference:1'
    elementFormDefault='qualified'>

  <xs:annotation>
    <xs:documentation>
      This schema defines the reference element specified in XEP-0372: Reference
    </xs:documentation>
    <xs:documentation source="http://www.xmpp.org/extensions/xep-0372.html"/>
  </xs:annotation>

  <xs:element name='reference'>
    <xs:complexType>
      <xs:simpleContent>
        <xs:extension base='xs:string'>
          <xs:attribute name='type' type='xs:string' use='required'/>
          <xs:attribute name='begin' type='xs:unsignedInt' use='optional'/>
          <xs:attribute name='end' type='xs:unsignedInt' use='optional'/>
          <xs:attribute name='anchor' type='xs:string' use='optional'/>
          <xs:attribute name='uri' type='xs:string' use='optional'/>
          <xs:attribute name='hreflang' type='xs:string' use='optional'/>
        </xs:extension>
      </xs:simpleContent>
    </xs:complexType>
  </xs:element>

</xs:schema>
]]></code>
  </section2>
</section1>
</xep>
