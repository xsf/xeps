<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE xep SYSTEM 'xep.dtd' [
  <!ENTITY % ents SYSTEM 'xep.ent'>
%ents;
]>
<?xml-stylesheet type='text/xsl' href='xep.xsl'?>
<xep>
<header>
  <title>Zero Handshake Server to Server Protocol</title>
  <abstract>
  This specification defines an approach for a pair of servers to eliminate initial handshakes and associated 
  data transfer when using the XMPP S2S Protocol.  This approach may only be used with a priori agreement and configuration 
  of the two servers involved.  This is of significant benefit in high latency environments.
  </abstract>
  <legal>
    <copyright>This XMPP Extension Protocol is copyright (c) 1999 - 2015 by the XMPP Standards Foundation (XSF).</copyright>
    <permissions>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the &quot;Specification&quot;), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.</permissions>
    <warranty>## NOTE WELL: This Specification is provided on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. In no event shall the XMPP Standards Foundation or the authors of this Specification be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification. ##</warranty>
    <liability>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising out of the use or inability to use the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.</liability>
    <conformance>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which may be found at &lt;<link url='http://xmpp.org/extensions/ipr-policy.shtml'>http://xmpp.org/extensions/ipr-policy.shtml</link>&gt; or obtained by writing to XSF, P.O. Box 1641, Denver, CO 80201 USA).</conformance>
  </legal>
  <number>xxxx</number>
  <status>ProtoXEP</status>
  <type>Informational</type>
  <sig>Standards</sig>
  <approver>Council</approver>
  <dependencies>
    <spec>RFC 6120</spec>
    <spec>RCC 6121</spec>
    
  </dependencies>
  <supersedes/>
  <supersededby/>
  <shortname>X2X</shortname>
  <author>
    <firstname>Steve</firstname>
    <surname>Kille</surname>
    <email>steve.kille@isode.com</email>
    <jid>steve.kille@isode.com</jid>
  </author>
  <revision>
    <version>0.0.1</version>
    <date>2015-06-22</date>
    <initials>sek</initials>
    <remark><p>First draft.</p></remark>
  </revision>
</header>
<section1 topic='Introduction' anchor='intro'>
  <p>
   This specification arose from work on deploying XMPP in high latency environments, with round trips of several second.  Even with data transfer rates as low as 2400 bit per second,  XMPP works well once connections are established as compressed messages are small and the protocols are fully asynchronous.  However the combination of low data rate and high latency led to connection establishment times of several minutes.   This was unworkable, particularly when connections were prone to failure.
  </p>
<p> 
The solution set out here is to eliminate all the initial handshaking and to start the S2S communication as if the handshaking had been correctly completed.  This cannot be used for communication between an arbitrary pair of servers, as in general the negotiation associated with the handshaking is vital for correctly determining a variety of parameters for use in the connection.    However, a pair of servers may operate by locally configuring information that would have been negotiated.   This enables the pair of servers to eliminate initial handshaking and data exchange.
</p>
</section1>
<section1 topic='Requirements' anchor='reqs'>
  <p>
    This specification can be considered as a profile for server to server XMPP communication, to enable XMPP deployment over high latency links.   This profile MUST only be used where its use has been pre-agreed and configured for both participating servers.  
  </p>
</section1>
<section1 topic='Glossary' anchor='glossary'>
  <p>OPTIONAL.
  </p>
  <p> Sections without text to be removed prior to sending doc for XSF review.</p>
</section1>
<section1 topic='Use Cases' anchor='usecases'>
  <p>STRONGLY RECOMMENDED.</p>
</section1>
<section1 topic='Business Rules' anchor='rules'>
  <p>Typically a pair of XMPP servers connecting using this protocol will communicate with multiple domains (e.g., a base domain and a MUC domain).   It is generally desirable to configure things so that all communications will share the same link, rather than establishing separate links for each domain.  Two or more connections MAY be initiated from one server to the other but this is NOT RECOMMENDED.   </p>
  <p>
    An XMPP server receiving messages over such a link should appropriately validate to and from elements of inbound messages.   The rules for this SHOULD be controlled by an priori agreement.  An inbound connection will generally be associated with several peer domains.   A RECOMMENDED approach is to consider each of these peers in turn and validate in the manner of a peer XMPP server connected using RFC 6120 for that domain.  In the event that an inbound message is not considered to be valid, it should be handled in a manner that this invalid message would be handled if it arrived over standard S2S.
  </p>
</section1>
<section1 topic='Implementation Notes' anchor='impl'>
  <section2 topic="General">
    <p>
      In simple terms, this can be considered as operation of RFC 6121 communication between a pair of XMPP servers without the preliminary negotiation done in RFC 6120.    It might be considered that the start point is the
      DONE box in Figure 3 of RFC 6120.  The TCP connection is opened and messages start to flow.  All configuration information, including choice of port is handled by a the a priori configuration.</p>
  </section2>
  <section2 topic="Connection Direction">
    <p>
    Connections may be opened by one server only or by either server.  The choice is part of the a priori configured agreement. It is generally recommended to allow connections to be opened by either server.  However policy or network constraints may require that the connection is initiated by one server only. When a server initiates a connection it MUST use this connection to send messages to the other server.    The server opening a connection is responsible for closing it at the end of its use.
    </p>
    <p>
 When a connection is opened by the peer server, the local server MAY use this connection to send messages or MAY open a connection.  It is recommended that only a single connection is used in this scenario and so in many cases this protocol will proceed with a single TCP connection and messages flowing in both directions.   In the event of both servers opening connections at the same time, both TCP connections SHOULD be used with messages sent on the connection opened by the message sender only.  
    </p>
  </section2>
  <section2 topic="Use of TLS">
    <p>
      This protocol MAY be deployed directly over TCP.   This will often be appropriate for environments where network security is handled at IP or lower layers or where the system is operated in closed network environment.
    </p>
    <p>
      This protocol may be deployed over TLS operating over TCP.  If this is done, TLS client and or server X.509 based authentication may be used, with certificate validation achieved by PKI or simply pinning (configuring) a trusted certificate.   This configuration and authentication is a part of the a priori configuration.
    </p>
  </section2>
</section1>
<section1 topic='Accessibility Considerations' anchor='access'>
  <p>OPTIONAL.</p>
</section1>
<section1 topic='Internationalization Considerations' anchor='i18n'>
  <p>OPTIONAL.</p>
</section1>
<section1 topic='Security Considerations' anchor='security'>
  <p>
    This protocol operates without the standard XMPP security negotiation.   It is imperative that consideration is given to link security whenever this protocol is set up. In particular it is important to validate the source IP address and source IP port of inbound connections against the a priori configuration.   This can be done directly by match of IP address or by use of reverse DNS lookup to identify the connecting server.
  </p>
</section1>
<section1 topic='IANA Considerations' anchor='iana'>
  <p>None.</p>
</section1>
<section1 topic='XMPP Registrar Considerations' anchor='registrar'>
  <p>None.</p>
</section1>
<section1 topic='XML Schema' anchor='schema'>
  <p>n/a.</p>
</section1>
  <section1 topic="Acknowledgement">
    <p>
      Dave Cridland, Curtis King, Kevin Smith and Kurt Zeilenga worked out and validated the approach documented in this XEP.
    </p>
  </section1>
</xep>
